import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:free_malware_detection/home/providers/threat_state.dart';
import 'package:freerasp/freerasp.dart';

/// Class responsible for setting up listeners to detected threats
class ThreatNotifier extends AutoDisposeNotifier<ThreatState> {
  @override
  ThreatState build() {
    _init();
    return ThreatState(detectedMalware: {}, isDetected: false);
  }

  void _init() {
    final threatCallback = ThreatCallback(onMalware: _updateMalware);
    Talsec.instance.attachListener(threatCallback);
  }

  void _updateMalware(List<SuspiciousAppInfo?> malware) {
    state = state.copyWith(
      detectedMalware: malware.nonNulls.toSet(),
      hasDetectedMalware: true,
    );
  }

  void removeMalware(SuspiciousAppInfo malware) {
    final malwareSet = state.detectedMalware..remove(malware);
    state = state.copyWith(detectedMalware: malwareSet);
  }
}

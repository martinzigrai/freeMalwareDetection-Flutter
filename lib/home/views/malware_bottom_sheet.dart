import 'package:android_intent_plus/android_intent.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:free_malware_detection/home/widgets/widgets.dart';
import 'package:free_malware_detection/main.dart';
import 'package:free_malware_detection/services/talsec_service.dart';
import 'package:freerasp/freerasp.dart';

/// Bottom sheet widget that displays malware information
class MalwareBottomSheet extends ConsumerWidget {
  /// Represents malware information in the example app
  const MalwareBottomSheet({
    required this.suspiciousApps,
    required this.onDismiss,
    super.key,
  });

  /// List of suspicious apps
  final List<SuspiciousAppInfo> suspiciousApps;
  final void Function()? onDismiss;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final textTheme = Theme.of(context).textTheme;
    final suspiciousApps = ref.watch(threatProvider).detectedMalware.toList();

    return Container(
      height: double.infinity,
      padding: const EdgeInsets.all(8),
      child: Column(
        children: [
          Text('Suspicious Apps', style: textTheme.titleMedium),
          const SizedBox(height: 8),
          Expanded(
            child: ListView.builder(
              itemCount: suspiciousApps.length,
              itemBuilder: (_, index) {
                final item = suspiciousApps[index];
                return MalwareItem(
                  packageInfo: item.packageInfo,
                  reason: item.reason,
                  onWhitelist: () {
                    _removeItem(ref, item);
                    TalsecService.whitelistApp(item);
                  },
                  onUninstall: () => _launchUninstall(item),
                  onDismiss: () {
                    _whitelistApp(item);
                    _removeItem(ref, item);
                  },
                );
              },
            ),
          ),
          const SizedBox(height: 16),
          SizedBox(
            width: double.infinity,
            child: FilledButton(
              onPressed: onDismiss,
              child: const Text('Dismiss'),
            ),
          ),
        ],
      ),
    );
  }

  void _removeItem(WidgetRef ref, SuspiciousAppInfo item) {
    ref.read(threatProvider.notifier).removeMalware(item);
  }

  Future<void> _whitelistApp(SuspiciousAppInfo malware) async {
    await TalsecService.whitelistApp(malware);
  }

  Future<void> _launchUninstall(SuspiciousAppInfo item) async {
    // Launch uninstall intent
    final packageName = item.packageInfo.packageName;
    await AndroidIntent(
      action: 'action_application_details_settings',
      data: 'package:$packageName',
    ).launch();
  }
}
